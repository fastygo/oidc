version: '3.8'

services:
  # --- OIDC Provider: ORY Hydra ---
  hydra-pg:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${HYDRA_DB_USER:-hydra}
      POSTGRES_PASSWORD: ${HYDRA_DB_PASSWORD:?}
      POSTGRES_DB: ${HYDRA_DB_NAME:-hydra}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HYDRA_DB_USER:-hydra}"]
      interval: 10s
      timeout: 30s
      retries: 5
    volumes:
      - hydra_pg_data:/var/lib/postgresql/data

  hydra-migrate:
    image: oryd/hydra:v2.3.0
    restart: on-failure
    depends_on:
      hydra-pg:
        condition: service_healthy
    environment:
      DSN: postgres://${HYDRA_DB_USER:-hydra}:${HYDRA_DB_PASSWORD:?}@hydra-pg:5432/${HYDRA_DB_NAME:-hydra}?sslmode=disable
    command: migrate sql -e --yes

  hydra:
    image: oryd/hydra:v2.3.0
    restart: unless-stopped
    depends_on:
      hydra-migrate:
        condition: service_started
    environment:
      # Database
      DSN: postgres://${HYDRA_DB_USER:-hydra}:${HYDRA_DB_PASSWORD:?}@hydra-pg:5432/${HYDRA_DB_NAME:-hydra}?sslmode=disable
      LOG_LEVEL: info

      # TLS is terminated by APISIX/Traefik (external TLS)
      SERVE_PUBLIC_TLS_ENABLED: "false"
      SERVE_ADMIN_TLS_ENABLED: "false"
      SERVE_PUBLIC_PORT: "4444"
      SERVE_ADMIN_PORT: "4445"

      # External issuer (public URL behind APISIX/Traefik)
      URLS_SELF_ISSUER: https://${AUTH_DOMAIN:?}

      # Demo Login & Consent (served via APISIX to hydra-login-consent)
      URLS_LOGIN: https://${AUTH_DOMAIN:?}/login
      URLS_CONSENT: https://${AUTH_DOMAIN:?}/consent

      # System secret (set in Coolify env)
      SECRETS_SYSTEM: ${HYDRA_SECRETS_SYSTEM:?}
    command: serve all
    # Ports are NOT published on host. Traffic goes through APISIX only.

  # Demo Login/Consent UI for Hydra (dev-friendly)
  hydra-login-consent:
    image: oryd/hydra-login-consent-node:v2.3.0
    restart: unless-stopped
    depends_on:
      hydra:
        condition: service_started
    environment:
      HYDRA_ADMIN_URL: http://hydra:4445
      BASE_URL: https://${AUTH_DOMAIN:?}
      NODE_ENV: production

  apisix:
    image: apache/apisix:3.8.0-debian
    restart: unless-stopped
    environment:
      # APISIX in standalone (YAML) mode - no etcd required
      APISIX_CONFIG: |
        apisix:
          node_listen: 9080
          enable_admin: false
        deployment:
          role: traditional
          role_traditional:
            config_provider: yaml
      # Standalone routes (loaded from apisix.yaml)
      APISIX_YAML: |
        routes:
          - uri: "/.well-known/*"
            upstream:
              type: roundrobin
              nodes:
                "hydra:4444": 1
            plugins:
              proxy-rewrite:
                headers:
                  X-Forwarded-Proto: "https"
          - uri: "/oauth2/*"
            upstream:
              type: roundrobin
              nodes:
                "hydra:4444": 1
            plugins:
              proxy-rewrite:
                headers:
                  X-Forwarded-Proto: "https"
          - uri: "/login*"
            upstream:
              type: roundrobin
              nodes:
                "hydra-login-consent:3000": 1
            plugins:
              proxy-rewrite:
                headers:
                  X-Forwarded-Proto: "https"
          - uri: "/consent*"
            upstream:
              type: roundrobin
              nodes:
                "hydra-login-consent:3000": 1
            plugins:
              proxy-rewrite:
                headers:
                  X-Forwarded-Proto: "https"
    command:
      - /bin/sh
      - -c
      - |
        printf "%s" "$$APISIX_CONFIG" > /usr/local/apisix/conf/config.yaml \
        && printf "%s" "$$APISIX_YAML" > /usr/local/apisix/conf/apisix.yaml \
        && /docker-entrypoint.sh docker-start
    labels:
      - traefik.enable=true
      - traefik.http.routers.apisix.entryPoints=websecure
      - 'traefik.http.routers.apisix.rule=Host(`$${AUTH_DOMAIN:?}`)'
      - traefik.http.routers.apisix.tls=true
      - traefik.http.services.apisix.loadbalancer.server.port=9080

volumes:
  hydra_pg_data:

