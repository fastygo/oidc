version: '3.8'

services:
  kratos-pg:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: ${KRATOS_DB_USER:-kratos}
      POSTGRES_PASSWORD: ${KRATOS_DB_PASSWORD:?}
      POSTGRES_DB: ${KRATOS_DB_NAME:-kratos}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KRATOS_DB_USER:-kratos}"]
      interval: 10s
      timeout: 30s
      retries: 5
    volumes:
      - kratos_pg_data:/var/lib/postgresql/data
    networks:
      - intranet

  kratos-migrate:
    image: oryd/kratos:v1.3.1
    depends_on:
      - kratos-pg
    environment:
      DSN: postgres://${KRATOS_DB_USER:-kratos}:${KRATOS_DB_PASSWORD:?}@kratos-pg:5432/${KRATOS_DB_NAME:-kratos}?sslmode=disable&max_conns=20&max_idle_conns=4
    command: -c /etc/config/kratos/kratos.yml migrate sql -e --yes
    volumes:
      - type: bind
        source: ./docker/kratos/configs
        target: /etc/config/kratos
    restart: on-failure
    networks:
      - intranet

  kratos:
    image: oryd/kratos:v1.3.1
    depends_on:
      - kratos-pg
    environment:
      # DB
      DSN: postgres://${KRATOS_DB_USER:-kratos}:${KRATOS_DB_PASSWORD:?}@kratos-pg:5432/${KRATOS_DB_NAME:-kratos}?sslmode=disable&max_conns=20&max_idle_conns=4
      LOG_LEVEL: info

      # Serve
      SERVE_PUBLIC_BASE_URL: https://${IDENTITY_DOMAIN:?}          # напр. identity.app-server.ru (если публикуете напрямик)
      SERVE_ADMIN_BASE_URL: http://kratos:4434

      # Self-Service
      SELFSERVICE_DEFAULT_BROWSER_RETURN_URL: https://${IDENTITY_DOMAIN:?}/
      SELFSERVICE_FLOWS_LOGIN_UI_URL: https://${IDENTITY_DOMAIN:?}/
      SELFSERVICE_FLOWS_REGISTRATION_UI_URL: https://${IDENTITY_DOMAIN:?}/
      SELFSERVICE_FLOWS_SETTINGS_UI_URL: https://${IDENTITY_DOMAIN:?}/
      SELFSERVICE_FLOWS_RECOVERY_ENABLED: "true"
      SELFSERVICE_FLOWS_RECOVERY_UI_URL: https://${IDENTITY_DOMAIN:?}/
      SELFSERVICE_FLOWS_VERIFICATION_ENABLED: "true"
      SELFSERVICE_FLOWS_VERIFICATION_UI_URL: https://${IDENTITY_DOMAIN:?}/

      # Mail (на проде замените на реальный SMTP URI)
      COURIER_SMTP_CONNECTION_URI: noop://
    command: serve --dev --watch-courier
    networks:
      - intranet

  # (Опционально) Пример UI для self-service
  kratos-selfservice-ui:
    image: oryd/kratos-selfservice-ui-node:v1.3.1
    environment:
      KRATOS_PUBLIC_URL: http://kratos:4433/
      KRATOS_BROWSER_URL: https://${IDENTITY_DOMAIN:?}/
      COOKIE_SECRET: ${KRATOS_COOKIE_SECRET:?}
      CSRF_COOKIE_NAME: ory_csrf_ui
      CSRF_COOKIE_SECRET: ${KRATOS_CSRF_SECRET:?}
    networks:
      - intranet
    restart: on-failure

networks:
  intranet:
    external: true

volumes:
  kratos_pg_data: