version: '3.8'

services:
  etcd:
    image: bitnami/etcd:3.5
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ENABLE_V2: "false"
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    volumes:
      - etcd_data:/bitnami/etcd
    healthcheck:
      test: ["CMD-SHELL", "etcdctl --endpoints=http://localhost:2379 endpoint health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - intranet

  apisix:
    image: apache/apisix:3.8.0-debian
    depends_on:
      - etcd
    environment:
      # Минимальный config.yaml через переменную окружения (без монтирования файла)
      APISIX_CONFIG: |
        apisix:
          node_listen: 9080
          enable_admin: true
          admin_key:
            - name: admin
              key: ${APISIX_ADMIN_KEY:-edd1c9f034335f136f87ad84b625c8f1}
              role: admin
        deployment:
          role: data_plane
          role_data_plane:
            config_provider: etcd
        etcd:
          host:
            - "http://etcd:2379"
          prefix: "/apisix"
          timeout: 30
    command:
      - /bin/sh
      - -c
      - |
        printf "%s" "$APISIX_CONFIG" > /usr/local/apisix/conf/config.yaml \
          && /docker-entrypoint.sh docker-start
    networks:
      - intranet
    labels:
      - traefik.enable=true
      - traefik.http.routers.apisix.entryPoints=websecure
      - traefik.http.routers.apisix.rule=Host(`auth.app-server.ru`)
      - traefik.http.routers.apisix.tls=true
      - traefik.http.services.apisix.loadbalancer.server.port=9080

  apisix-init:
    image: curlimages/curl:8.10.1
    depends_on:
      - apisix
    environment:
      APISIX_ADMIN: http://apisix:9180
      APISIX_ADMIN_KEY: ${APISIX_ADMIN_KEY:-edd1c9f034335f136f87ad84b625c8f1}
    command:
      - /bin/sh
      - -c
      - |
        set -e

        wait() {
          for i in $(seq 1 30); do
            if curl -fsS "${APISIX_ADMIN}/apisix/admin/routes" -H "X-API-KEY: ${APISIX_ADMIN_KEY}" >/dev/null 2>&1; then
              exit 0
            fi
            sleep 2
          done
          echo "APISIX Admin API not ready" >&2
          exit 1
        }

        mkroute() {
          id="$1"; uri="$2"; upstream="$3"; port="$4"
          curl -fsS -X PUT "${APISIX_ADMIN}/apisix/admin/routes/${id}" \
            -H "X-API-KEY: ${APISIX_ADMIN_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"uri\": \"${uri}\",
              \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"${upstream}:${port}\": 1 } },
              \"plugins\": {
                \"proxy-rewrite\": {
                  \"headers\": { \"X-Forwarded-Proto\": \"https\" }
                }
              }
            }"
          echo
        }

        wait

        # Hydra (OIDC): /.well-known/* и /oauth2/*
        mkroute hydra-well-known \"/.well-known/*\" hydra 4444
        mkroute hydra-oauth2   \"/oauth2/*\"       hydra 4444

        # Kratos (public): /self-service/* /sessions/* /identities/*
        mkroute kratos-self-service \"/self-service/*\" kratos 4433
        mkroute kratos-sessions     \"/sessions/*\"      kratos 4433
        mkroute kratos-identities   \"/identities/*\"    kratos 4433

        echo \"APISIX routes applied\"
        sleep 3600
    networks:
      - intranet

networks:
  intranet:
    external: true

volumes:
  etcd_data: