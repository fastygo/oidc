# Authelia SSO for Coolify

Modern authentication and authorization server with Single Sign-On (SSO) and Multi-Factor Authentication (MFA).

## üöÄ Features

- ‚úÖ Single Sign-On (SSO) with OpenID Connect
- ‚úÖ Multi-Factor Authentication (TOTP, WebAuthn, Duo)
- ‚úÖ Access Control Lists (ACL)
- ‚úÖ Password Reset Portal
- ‚úÖ User-friendly Web Interface
- ‚úÖ Integration with Traefik reverse proxy
- ‚úÖ Optimized for Coolify deployment

## üìã Prerequisites

- Coolify instance with Traefik proxy configured
- Wildcard domain configured in Coolify
- HTTPS/TLS certificates (Let's Encrypt)

## üîß Deployment to Coolify

### Step 1: Fork/Clone this Repository

1. Fork this repository to your GitHub account
2. Or create a new repository and copy these files

### Step 2: Add to Coolify

1. Go to Coolify Dashboard
2. Click **"Add Resource"** ‚Üí **"Docker Compose"**
3. Select **"Public Repository"**
4. Enter your repository URL
5. Click **"Continue"**

### Step 3: Configure Environment Variables

In Coolify's Environment Variables section, add:

#### Required Variables:

```env
ROOT_DOMAIN=yourdomain.com
TZ=Europe/Moscow
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** `ROOT_DOMAIN` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ë–ï–ó –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (http/https) –∏ –ë–ï–ó –ø–æ–¥–¥–æ–º–µ–Ω–∞!

‚ùå **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:** `ROOT_DOMAIN=https://auth.yourdomain.com`  
‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û:** `ROOT_DOMAIN=yourdomain.com`

#### Magic Variables (Auto-generated by Coolify):

These will be automatically created:
- `SERVICE_PASSWORD_64_JWT` - JWT secret (64 chars)
- `SERVICE_PASSWORD_64_SESSION` - Session secret (64 chars)
- `SERVICE_PASSWORD_64_STORAGE` - Storage encryption key (64 chars)
- `SERVICE_FQDN_AUTHELIA` - Auto-generated domain
- `SERVICE_URL_AUTHELIA_9091` - Full URL with port

#### Optional Variables:

```env
LOG_LEVEL=info
LOG_FORMAT=text
THEME=dark
```

### Step 4: Configure Domain

1. In Coolify, find the `authelia` service
2. Click **"Domains"**
3. Add your domain: `auth.yourdomain.com`
4. Coolify will automatically configure Traefik

### Step 5: Deploy

Click **"Deploy"** button in Coolify

## üë§ Default Credentials

**‚ö†Ô∏è IMPORTANT: Change these immediately after first login!**

- **Username:** `admin`
- **Password:** `authelia`

### Change Default Password

1. Generate new password hash:
```bash
docker run authelia/authelia:latest authelia crypto hash generate argon2 --password 'your-new-password'
```

2. Update `config/users.yml` with new hash
3. Commit changes to GitHub
4. Click **"Redeploy"** in Coolify

## üîê Configuration Files

### `docker-compose.yml`
Main deployment configuration with Coolify magic variables and Traefik labels.

### `config/configuration.yml`
Authelia server configuration:
- Server settings
- Authentication backend
- Access control rules
- Session management
- Storage configuration
- Notification settings
- OIDC provider (optional)

### `config/users.yml`
User database (for file-based authentication):
- User credentials
- Groups and permissions
- Email addresses

## üõ°Ô∏è Protecting Services with Authelia

To protect any service with Authelia authentication, add this label to your service in Coolify:

```yaml
labels:
  - traefik.http.routers.your-service.middlewares=authelia@docker
```

Example in docker-compose:

```yaml
services:
  your-app:
    image: your-app:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.your-app.rule=Host(`app.yourdomain.com`)
      - traefik.http.routers.your-app.entrypoints=https
      - traefik.http.routers.your-app.middlewares=authelia@docker
```

## üìù Access Control Rules

Edit `config/configuration.yml` to configure access rules:

```yaml
access_control:
  default_policy: 'deny'
  
  rules:
    # Public access
    - domain: 'public.example.com'
      policy: 'bypass'
    
    # One-factor authentication
    - domain: 'app.example.com'
      policy: 'one_factor'
    
    # Two-factor authentication
    - domain: 'admin.example.com'
      policy: 'two_factor'
    
    # Admin-only access
    - domain: 'secure.example.com'
      policy: 'two_factor'
      subject:
        - 'group:admin'
```

## üîÑ Updating Configuration

1. Edit configuration files in your GitHub repository
2. Commit and push changes
3. Go to Coolify ‚Üí Your Authelia service
4. Click **"Redeploy"**
5. Coolify will pull latest changes and restart

## üóÑÔ∏è Storage Options

### SQLite (Default)
Good for small deployments, no additional setup needed.

### PostgreSQL (Recommended for Production)

1. Add PostgreSQL service to your docker-compose
2. Update `config/configuration.yml`:

```yaml
storage:
  postgres:
    address: 'tcp://postgres:5432'
    database: 'authelia'
    username: 'authelia'
    password: '${DB_PASSWORD}'
```

3. Add environment variable in Coolify:
```env
DB_PASSWORD=${SERVICE_PASSWORD_DB}
```

## üìß Email Notifications

### Enable SMTP

1. Update `config/configuration.yml`:

```yaml
notifier:
  smtp:
    address: 'smtp://smtp.gmail.com:587'
    username: 'your-email@gmail.com'
    password: '${SMTP_PASSWORD}'
    sender: 'Authelia <noreply@yourdomain.com>'
```

2. Add to Coolify environment variables:
```env
SMTP_PASSWORD=your-app-password
```

## üîå OpenID Connect (OIDC) Integration

To enable SSO for applications, uncomment the `identity_providers` section in `config/configuration.yml`.

### Generate OIDC Keys

```bash
# Generate HMAC secret
docker run authelia/authelia:latest authelia crypto rand --length 64 --charset alphanumeric

# Generate RSA private key
docker run authelia/authelia:latest authelia crypto certificate rsa generate --bits 4096
```

### Example OIDC Client Configuration

```yaml
identity_providers:
  oidc:
    clients:
      - client_id: 'my-app'
        client_name: 'My Application'
        client_secret: '$pbkdf2-sha512$...'
        redirect_uris:
          - 'https://my-app.example.com/oauth2/callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
          - 'groups'
```

## üêõ Troubleshooting

### Check Logs

In Coolify:
1. Go to your Authelia service
2. Click **"Logs"**
3. Check for errors

### Common Issues

**Issue:** Can't access Authelia UI
- Check domain configuration in Coolify
- Verify Traefik is running
- Check SSL certificate status

**Issue:** Authentication not working
- Verify secrets are generated (check environment variables)
- Check `config/configuration.yml` syntax
- Verify user credentials in `config/users.yml`

**Issue:** Services not protected
- Ensure `authelia@docker` middleware is applied
- Check Traefik labels on protected service
- Verify both services are on same network

## üìö Documentation

- [Authelia Official Docs](https://www.authelia.com/)
- [Coolify Documentation](https://coolify.io/docs)
- [Traefik ForwardAuth](https://doc.traefik.io/traefik/middlewares/http/forwardauth/)

## üîí Security Best Practices

1. ‚úÖ Change default admin password immediately
2. ‚úÖ Use strong passwords (min 12 characters)
3. ‚úÖ Enable 2FA for all users
4. ‚úÖ Use PostgreSQL for production
5. ‚úÖ Enable SMTP for password resets
6. ‚úÖ Regularly update Authelia image
7. ‚úÖ Review access control rules periodically
8. ‚úÖ Monitor logs for suspicious activity

## üìÑ License

This configuration is provided as-is for use with Coolify deployments.

## ü§ù Contributing

Feel free to submit issues and enhancement requests!

---

**Made with ‚ù§Ô∏è for Coolify users**

